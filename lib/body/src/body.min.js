"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var l=Object.prototype.toString.call(e).slice(8,-1);return"Object"===l&&e.constructor&&(l=e.constructor.name),"Map"===l||"Set"===l?Array.from(e):"Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var l=0,r=new Array(t);l<t;l++)r[l]=e[l];return r}function _defineProperty(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}var scrollProcessTimeout,cellType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function countTreeExpand(e,t){var l=t.$table,r=e[l.treeOpts.children],o=1;if(l.isTreeExpandByRow(e))for(var n=0;n<r.length;n++)o+=countTreeExpand(r[n],t);return o}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,t){var l=e.$table,r=e.$rowIndex,o=1;return r&&(o=countTreeExpand(t[r-1],e)),l.rowHeight*o-(r?1:12-getOffsetSize(l))}function renderLine(e,t,l,r,o,n){var i=n.column,s=l.treeOpts,a=l.treeConfig;return i.slots&&i.slots.line?i.slots.line.call(l,n,e):i.treeNode&&a&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,o),"px"),left:"".concat(r*s.indent+(r?2-getOffsetSize(l):0)+16,"px")}})])]:[]}function renderColumn(e,t,l,r,o,n,i,s,a,c,d,u,p,f,y){var v,g=l._e,x=l.$listeners,m=l.tableData,h=l.height,b=l.columnKey,w=l.overflowX,_=l.scrollXLoad,T=l.scrollYLoad,S=l.highlightCurrentRow,O=l.showOverflow,$=l.align,C=l.currentColumn,L=l.cellClassName,k=l.cellStyle,E=l.spanMethod,R=l.radioOpts,I=l.checkboxOpts,A=l.expandOpts,P=l.treeOpts,U=l.tooltipOpts,B=l.mouseConfig,q=l.mouseOpts,D=l.editConfig,H=l.editOpts,M=l.editRules,j=l.validOpts,N=l.editStore,X=l.validStore,z=u.type,W=u.editRender,Y=u.align,F=u.showOverflow,K=u.className,G=u.treeNode,V=N.actived,J=U.enabled,Q=l.getColumnIndex(u),N=l._getColumnIndex(u),U=B&&q.selected,B=i?u.fixed!==i:u.fixed&&w,q=_xeUtils.default.isUndefined(F)||_xeUtils.default.isNull(F)?O:F,w="ellipsis"===q,Z="title"===q,ee=!0===q||"tooltip"===q,F=Z||ee||w,q={},Y=Y||$,$=X.row===a&&X.column===u,M=M&&("default"===j.message?h||1<m.length:"inline"===j.message),h={"data-colid":u.id},te=x["cell-mouseenter"],le=x["cell-mouseleave"],j=W&&D&&"dblclick"===H.trigger,re={$table:l,$seq:r,seq:o,rowid:n,row:a,rowIndex:c,$rowIndex:d,column:u,columnIndex:Q,$columnIndex:p,_columnIndex:N,fixed:i,type:cellType,isHidden:B,level:s,data:m,items:y};if(!_&&!T||F||(w=F=!0),(Z||ee||J||te)&&(q.mouseenter=function(e){isOperateMouse(l)||(Z?_tools.DomTools.updateCellTitle(e,u):(ee||J)&&l.triggerTooltipEvent(e,re),te&&l.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},re),e))}),(ee||J||le)&&(q.mouseleave=function(e){isOperateMouse(l)||((ee||J)&&l.handleTargetLeaveEvent(e),le&&l.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},re),e))}),(I.range||U)&&(q.mousedown=function(e){l.triggerCellMousedownEvent(e,re)}),(S||x["cell-click"]||W&&D||"row"===A.trigger||"cell"===A.trigger||"row"===R.trigger||"radio"===u.type&&"cell"===R.trigger||"row"===I.trigger||"checkbox"===u.type&&"cell"===I.trigger||"row"===P.trigger||u.treeNode&&"cell"===P.trigger)&&(q.click=function(e){l.triggerCellClickEvent(e,re)}),(j||x["cell-dblclick"])&&(q.dblclick=function(e){l.triggerCellDBLClickEvent(e,re)}),E){var oe=E(re)||{},E=oe.rowspan,E=void 0===E?1:E,oe=oe.colspan,oe=void 0===oe?1:oe;if(!E||!oe)return null;1<E&&(h.rowspan=E),1<oe&&(h.colspan=oe)}return!B&&W&&D&&H.showStatus&&(v=l.isUpdateByRow(a,u.property)),e("td",{class:["vxe-body--column",u.id,(_defineProperty(oe={},"col--".concat(Y),Y),_defineProperty(oe,"col--".concat(z),z),_defineProperty(oe,"col--last",p===f.length-1),_defineProperty(oe,"col--tree-node",G),_defineProperty(oe,"col--edit",!!W),_defineProperty(oe,"col--ellipsis",F),_defineProperty(oe,"fixed--hidden",B),_defineProperty(oe,"col--dirty",v),_defineProperty(oe,"col--actived",D&&W&&V.row===a&&(V.column===u||"row"===H.mode)),_defineProperty(oe,"col--valid-error",$),_defineProperty(oe,"col--current",C===u),oe),_tools.UtilTools.getClass(K,re),_tools.UtilTools.getClass(L,re)],key:b?u.id:p,attrs:h,style:k?_xeUtils.default.isFunction(k)?k(re):k:null,on:q},O&&B?[e("div",{class:["vxe-cell",{"c--title":Z,"c--tooltip":ee,"c--ellipsis":w}]})]:renderLine(e,t,l,s,y,re).concat([e("div",{class:["vxe-cell",{"c--title":Z,"c--tooltip":ee,"c--ellipsis":w}],attrs:{title:Z?_tools.UtilTools.getCellLabel(a,u,re):null}},u.renderCell(e,re)),M?$?e("div",{class:"vxe-cell--valid",style:X.rule&&X.rule.maxWidth?{width:"".concat(X.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},X.content)]):g():null]))}function renderRows(c,d,u,p,f,y,v,g){var x=u.stripe,m=u.rowKey,h=u.highlightHoverRow,b=u.rowClassName,w=u.rowStyle,_=u.showOverflow,T=u.treeConfig,S=u.treeOpts,O=u.treeExpandeds,$=u.scrollYLoad,C=u.scrollYStore,L=u.editStore,k=u.rowExpandeds,E=u.radioOpts,R=u.checkboxOpts,I=u.expandColumn,A=[];return v.forEach(function(l,r){var e={},o=r,n=o+1;$&&(n+=C.startIndex),o=u.getRowIndex(l),h&&(e.mouseenter=function(e){isOperateMouse(u)||u.triggerHoverEvent(e,{row:l,rowIndex:o})},e.mouseleave=function(){isOperateMouse(u)||u.clearHoverRow()});var t,i,s=_tools.UtilTools.getRowid(u,l),a={$table:u,$seq:p,seq:n,rowid:s,fixed:y,type:cellType,rowLevel:f,row:l,rowIndex:o,$rowIndex:r};A.push(c("tr",{class:["vxe-body--row",{"row--stripe":x&&(u._getRowIndex(l)+1)%2==0,"is--new":-1<L.insertList.indexOf(l),"row--radio":E.highlight&&u.selectRow===l,"row--cheched":R.highlight&&u.isCheckedByCheckboxRow(l)},b?_xeUtils.default.isFunction(b)?b(a):b:""],attrs:{"data-rowid":s},style:w?_xeUtils.default.isFunction(w)?w(a):w:null,key:m||T?s:r,on:e},g.map(function(e,t){return renderColumn(c,d,u,p,n,s,y,f,l,o,r,e,t,g,v)}))),I&&k.length&&-1<k.indexOf(l)&&(T&&(t={paddingLeft:"".concat(f*S.indent+30,"px")}),i=I.showOverflow,a=_xeUtils.default.isUndefined(i)||_xeUtils.default.isNull(i)?_:i,i={$table:u,$seq:p,seq:n,column:I,fixed:y,type:cellType,level:f,row:l,rowIndex:o,$rowIndex:r},A.push(c("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:w?_xeUtils.default.isFunction(w)?w(i):w:null,on:e},[c("td",{class:["vxe-body--expanded-column",{"fixed--hidden":y,"col--ellipsis":a}],attrs:{colspan:g.length}},[c("div",{class:"vxe-body--expanded-cell",style:t},[I.renderData(c,i)])])]))),T&&O.length&&((i=l[S.children])&&i.length&&-1<O.indexOf(l)&&A.push.apply(A,_toConsumableArray(renderRows(c,d,u,(p?"".concat(p,"."):"").concat(n),f+1,y,i,g))))}),A}function syncBodyScroll(e,t,l){(t||l)&&(t&&(t.onscroll=null,t.scrollTop=e),l&&(l.onscroll=null,l.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){t&&(t.onscroll=t._onscroll),l&&(l.onscroll=l._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,t=this.$el,l=this.$refs,r=this.fixedType,e=e.elemStore,r="".concat(r||"main","-body-");e["".concat(r,"wrapper")]=t,e["".concat(r,"table")]=l.table,e["".concat(r,"colgroup")]=l.colgroup,e["".concat(r,"list")]=l.tbody,e["".concat(r,"xSpace")]=l.xSpace,e["".concat(r,"ySpace")]=l.ySpace,e["".concat(r,"checkRange")]=l.checkRange,e["".concat(r,"emptyBlock")]=l.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(l){var e=this._e,t=this.$parent,r=this.fixedColumn,o=this.fixedType,n=t.$scopedSlots,i=t.tId,s=t.tableData,a=t.tableColumn,c=t.showOverflow,d=t.spanMethod,u=t.scrollXLoad,p=t.emptyRender,f=t.emptyOpts;return d||(o&&c||u&&o)&&(a=r),f=n.empty?n.empty.call(this,{$table:t},l):(p=p?_vXETable.default.renderer.get(f.name):null)&&p.renderEmpty?p.renderEmpty.call(this,l,f,{$table:t},{$table:t}):_conf.default.i18n("vxe.table.emptyText"),l("div",{class:["vxe-table--body-wrapper",o?"fixed-".concat(o,"--wrapper"):"body--wrapper"],attrs:{"data-tid":i}},[o?e():l("div",{class:"vxe-body--x-space",ref:"xSpace"}),l("div",{class:"vxe-body--y-space",ref:"ySpace"}),l("table",{class:"vxe-table--body",attrs:{"data-tid":i,cellspacing:0,cellpadding:0,border:0},ref:"table"},[l("colgroup",{ref:"colgroup"},a.map(function(e,t){return l("col",{attrs:{name:e.id},key:t})})),l("tbody",{ref:"tbody"},renderRows(l,this,t,"",0,o,s,a))]),l("div",{ref:"checkRange",class:"vxe-table--checkbox-range"}),o?null:l("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[l("div",{class:"vxe-table--empty-content"},f)])])},methods:{scrollEvent:function(e){var t=this.$parent,l=this.fixedType,r=t.$refs,o=t.highlightHoverRow,n=t.scrollXLoad,i=t.scrollYLoad,s=t.lastScrollTop,a=t.lastScrollLeft,c=r.tableHeader,d=r.tableBody,u=r.leftBody,p=r.rightBody,f=r.tableFooter,r=r.validTip,y=c?c.$el:null,c=f?f.$el:null,v=d.$el,f=u?u.$el:null,d=p?p.$el:null,u=v.scrollTop,p=v.scrollLeft,a=p!==a,s=u!==s;t.lastScrollTop=u,t.lastScrollLeft=p,t.lastScrollTime=Date.now(),o&&t.clearHoverRow(),f&&"left"===l?syncBodyScroll(u=f.scrollTop,v,d):d&&"right"===l?syncBodyScroll(u=d.scrollTop,v,f):(a&&(y&&(y.scrollLeft=v.scrollLeft),c&&(c.scrollLeft=v.scrollLeft)),(f||d)&&(t.checkScrolling(),s&&syncBodyScroll(u,f,d))),n&&a&&(t.triggerScrollXEvent(e),y&&p+v.clientWidth>=v.scrollWidth-80&&this.$nextTick(function(){v.scrollLeft!==y.scrollLeft&&(y.scrollLeft=v.scrollLeft)})),i&&s&&t.triggerScrollYEvent(e),a&&r&&r.visible&&r.updatePlacement(),t.emitEvent("scroll",{type:cellType,fixed:l,scrollTop:u,scrollLeft:p,isX:a,isY:s},e)}}};exports.default=_default;